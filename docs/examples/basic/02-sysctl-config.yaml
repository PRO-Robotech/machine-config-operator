# =============================================================================
# Kernel Parameters (sysctl) Configuration
# =============================================================================
#
# This example configures kernel network and memory parameters.
#
# What it does:
#   - Creates /etc/sysctl.d/99-mco-network.conf with kernel parameters
#   - Requires reboot to fully apply (some params need it)
#
# Prerequisites:
#   - MachineConfigPool "worker" must exist
#
# Apply:
#   kubectl apply -f 02-sysctl-config.yaml
#
# Verify:
#   kubectl get mc sysctl-network
#   minikube ssh "cat /etc/sysctl.d/99-mco-network.conf"
#   minikube ssh "sysctl net.ipv4.ip_forward"
#
# Note:
#   If pool has reboot.strategy: Never, you need to reboot manually.
#   Check: kubectl get node NODE -o jsonpath='{.metadata.annotations.mco\.in-cloud\.io/reboot-pending}'
#
# =============================================================================

apiVersion: mco.in-cloud.io/v1alpha1
kind: MachineConfig
metadata:
  name: sysctl-network
  labels:
    mco.in-cloud.io/pool: worker
spec:
  # Lower priority than NTP - applied first
  priority: 40

  files:
    - path: /etc/sysctl.d/99-mco-network.conf
      content: |
        # Managed by MCO Lite - do not edit manually
        #
        # Network settings
        #

        # Enable IP forwarding (required for Kubernetes networking)
        net.ipv4.ip_forward = 1
        net.ipv6.conf.all.forwarding = 1

        # Enable bridge netfilter (required for Kubernetes)
        net.bridge.bridge-nf-call-iptables = 1
        net.bridge.bridge-nf-call-ip6tables = 1

        # Increase connection tracking table size
        net.netfilter.nf_conntrack_max = 1000000

        # Increase max socket buffer sizes
        net.core.rmem_max = 16777216
        net.core.wmem_max = 16777216

        # Increase listen backlog
        net.core.somaxconn = 65535

        #
        # Memory settings
        #

        # Reduce swappiness for better performance
        vm.swappiness = 10

        # Increase max memory map areas
        vm.max_map_count = 262144
      mode: 420
      owner: "root:root"
      state: present

  reboot:
    # Some kernel parameters require reboot to take full effect
    required: true
    reason: "Kernel parameters may require reboot for full effect"
