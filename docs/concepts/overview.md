# Обзор MCO Lite

## Что такое MCO Lite

**Machine Config Operator Lite (MCO Lite)** — это Kubernetes-оператор для декларативного управления конфигурацией хостов (нод) в кластере.

С помощью MCO Lite вы можете:
- **Управлять файлами** — создавать, обновлять и удалять конфигурационные файлы на нодах
- **Управлять systemd** — включать/выключать сервисы, запускать/останавливать их
- **Контролировать перезагрузки** — определять когда нода может перезагрузиться
- **Выполнять Rolling Update** — обновлять ноды по одной или группами с контролем `maxUnavailable`
- **Cordon/Drain** — автоматически изолировать и эвакуировать поды перед обновлением

---

## Ключевые особенности

### 1. Работает с любым Linux

В отличие от OpenShift MCO, который привязан к Red Hat CoreOS (RHCOS), MCO Lite работает с **любым дистрибутивом Linux**:
- Ubuntu
- Debian
- CentOS / Rocky Linux
- Fedora
- И любой другой с systemd

### 2. Простой YAML вместо Ignition

MCO Lite использует понятный YAML-формат:

```yaml
files:
  - path: /etc/myapp/config.conf
    content: |
      key=value
    mode: 0644
```

Вместо сложного формата Ignition от CoreOS.

### 3. Без обновления ОС

MCO Lite **не управляет обновлениями операционной системы** (нет rpm-ostree).
Он фокусируется только на конфигурации:
- Файлы
- Systemd-юниты
- Настройки, требующие перезагрузки

### 4. Контролируемые перезагрузки

Перезагрузки нод полностью под вашим контролем:

| Стратегия | Поведение |
|-----------|-----------|
| `Never` | Ноды **никогда** не перезагружаются автоматически |
| `IfRequired` | Ноды перезагружаются **только если** конфигурация этого требует |

### 5. Приоритеты и слияние

Несколько MachineConfig могут управлять одной нодой. MCO Lite:
- Сортирует конфиги по приоритету
- Сливает их в единую конфигурацию (RenderedMachineConfig)
- При конфликтах побеждает конфиг с **высшим приоритетом**
- При равном приоритете побеждает конфиг с **большим именем** (алфавитно)

### 6. Rolling Update с maxUnavailable

Обновление нод происходит контролируемо:

```yaml
spec:
  rollout:
    maxUnavailable: 1      # Обновлять по одной ноде
    # или
    maxUnavailable: "25%"  # Обновлять 25% нод одновременно
```

### 7. Cordon/Drain перед обновлением

Перед применением конфигурации MCO Lite:
1. **Cordon** — помечает ноду как unschedulable
2. **Drain** — эвакуирует поды с учётом PodDisruptionBudget
3. **Apply** — применяет конфигурацию
4. **Uncordon** — возвращает ноду в работу

### 8. Обнаружение Pool Overlap

MCO Lite автоматически обнаруживает когда нода попадает в несколько пулов и блокирует обновления для таких нод.

---

## Сценарии использования

### Централизованное управление настройками

```
┌─────────────────┐
│  MachineConfig  │  NTP, sysctl, SSH...
│    (YAML)       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────┐
│   Controller    │────▶│  Node 1 │ ← Cordon → Drain → Apply → Uncordon
│                 │     └─────────┘
│   Render &      │     ┌─────────┐
│   Distribute    │────▶│  Node 2 │ ← (ждёт пока Node 1 завершит)
│                 │     └─────────┘
└─────────────────┘     ┌─────────┐
                   ────▶│  Node N │
                        └─────────┘
```

### Разделение по ролям

| Пул | Ноды | Конфигурация |
|-----|------|--------------|
| `master` | control-plane | Более консервативные настройки |
| `worker` | рабочие ноды | Настройки для workload |
| `gpu` | GPU-ноды | Специфичные драйверы и настройки |

### Стандартизация окружения

Обеспечьте одинаковую конфигурацию на всех нодах:
- Единые настройки sysctl
- Одинаковая конфигурация NTP
- Стандартные SSH-ключи
- Корпоративные сертификаты

---

## Сравнение с альтернативами

| Характеристика | MCO Lite | Ansible | OpenShift MCO |
|----------------|----------|---------|---------------|
| Декларативный | ✅ | ⚠️ Частично | ✅ |
| Kubernetes-native | ✅ | ❌ | ✅ |
| Любой Linux | ✅ | ✅ | ❌ RHCOS only |
| Без агента | ❌ | ✅ | ❌ |
| GitOps-совместим | ✅ | ⚠️ | ✅ |
| Контроль перезагрузок | ✅ | ❌ | ✅ |
| Rolling Update | ✅ | ⚠️ Manual | ✅ |
| Cordon/Drain | ✅ | ❌ | ✅ |
| PDB-aware drain | ✅ | ❌ | ✅ |

---

## Когда использовать MCO Lite

**Подходит:**
- Управление конфигурацией Kubernetes-нод
- Стандартизация настроек в кластере
- GitOps-подход к управлению инфраструктурой
- Контролируемые изменения с отслеживанием статуса
- Rolling update с минимальным влиянием на workload

**Не подходит:**
- Обновление операционной системы
- Управление серверами вне Kubernetes
- Разовые ad-hoc изменения (используйте Ansible)

---

## Следующие шаги

- [Архитектура](architecture.md) — как работает MCO Lite внутри
- [Терминология](glossary.md) — ключевые понятия
- [Быстрый старт](../getting-started/quickstart.md) — начать использовать

